<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Geotab Bridge</title>
</head>
<body>
    
    <div id="geotab-map-addin-container" style="height:100vh; width:100%; overflow:hidden; position: relative;">
        <div id="loading-overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; background:white; z-index:10; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <h3 style="color:#333;">Loading Dashboard...</h3>
            <p id="debug-status" style="color:#666; font-size:12px;">Initializing Connection...</p>
        </div>
    </div>

    <script type="text/javascript">
        console.log("BRIDGE: File loaded (Promise Version).");

        /**
         * MAP ADD-IN ENTRY POINT
         * Signature per documentation: (elt, service)
         */
        var myMapAddinLogic = function (element, services) {
            
            console.log("BRIDGE: Factory started.");

            // 1. CONFIGURATION
            var TARGET_APP_PAGE = "https://farindn.github.io/vehicle-status-addin/dashboard.html"; 
            
            // 2. EXTRACT SERVICES
            // The docs say 'service' contains api, events, etc.
            var apiService = services.api; 

            var isRendered = false;

            var renderDashboard = function() {
                if (isRendered) return;
                
                var container = document.getElementById("geotab-map-addin-container");
                var status = document.getElementById("debug-status");
                var overlay = document.getElementById("loading-overlay");

                status.innerText = "Requesting Session (Promise)...";

                // 3. THE FIX: USE PROMISES
                // The documentation confirms: getSession(): Promise<ISessionInfo>
                apiService.getSession()
                    .then(function(session) {
                        console.log("BRIDGE: Session Success!", session);
                        
                        var userName = session.userName;
                        var sessionId = session.sessionId;
                        var database = session.database;
                        // Map Add-ins don't always expose mobileCaller, fallback to hostname
                        var server = window.location.hostname;

                        var iframeUrl = TARGET_APP_PAGE + 
                                        "?userName=" + encodeURIComponent(userName) + 
                                        "&sessionId=" + encodeURIComponent(sessionId) + 
                                        "&database=" + encodeURIComponent(database) + 
                                        "&server=" + encodeURIComponent(server);

                        var iframe = document.createElement('iframe');
                        iframe.src = iframeUrl;
                        iframe.style.width = "100%";
                        iframe.style.height = "100%";
                        iframe.style.border = "none";
                        
                        container.appendChild(iframe);
                        
                        // Hide overlay
                        if (overlay) overlay.style.display = 'none';
                        isRendered = true;
                    })
                    .catch(function(err) {
                        console.error("BRIDGE: Session Error", err);
                        status.innerText = "Error: " + err.message;
                    });
            };

            // 4. LIFECYCLE MANAGEMENT
            return {
                initialize: function (api, state, callback) {
                    renderDashboard();
                    // Map Add-in initialize might not use a callback, but good to include if legacy
                    if (callback) callback();
                },
                focus: function (api, state) {
                    renderDashboard();
                },
                blur: function () { 
                    console.log("BRIDGE: Blurred");
                }
            };
        };

        // Register the namespace
        geotab.addin.myMetrics = myMapAddinLogic;
        // Legacy register just in case
        geotab.addin.mapMetricsTest = myMapAddinLogic;

    </script>
</body>
</html>
