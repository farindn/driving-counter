<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Geotab Map Add-In Bridge</title>
</head>
<body>
    
    <div id="geotab-map-addin-container" style="height:100vh; width:100%; overflow:hidden; position: relative;">
        <div id="loading-overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; background:white; z-index:10; display:flex; flex-direction:column; justify-content:center; align-items:center; font-family: sans-serif;">
            <h3 style="color:#25457B;">Fleet Status Overview</h3>
            <p id="debug-status" style="color:#666; font-size:12px;">Syncing...</p>
        </div>
    </div>

    <script type="text/javascript">
        var fleetStatusAddin = function (element, services) {
            
            var DASHBOARD_URL = "https://farindn.github.io/vehicle-status-addin/dashboard.html"; 
            var isRendered = false;
            var iframeRef = null; // Store reference to talk to it later
            
            var apiService = (services && services.api) ? services.api : null;
            var pageService = (services && services.page) ? services.page : null;

            // --- HELPER: Send Data to React ---
            var sendGroupUpdate = function(groups) {
                if (!iframeRef || !iframeRef.contentWindow) return;
                
                var groupIds = groups.map(function(g) { return g.id; }).join(",");
                console.log("BRIDGE: Sending new groups to React:", groupIds);
                
                iframeRef.contentWindow.postMessage({
                    type: "FILTER_UPDATE",
                    groups: groupIds
                }, "*"); // In production, replace '*' with your specific DASHBOARD_URL origin for security
            };

            var renderDashboard = function() {
                if (isRendered) return;
                
                var container = document.getElementById("geotab-map-addin-container");
                var overlay = document.getElementById("loading-overlay");

                if (!container) { setTimeout(renderDashboard, 200); return; }
                
                if (!apiService || !pageService) return;

                Promise.all([
                    apiService.getSession(),
                    pageService.getFilterState()
                ]).then(function(results) {
                    var session = results[0];
                    var filterGroups = results[1];
                    var groupIds = filterGroups.map(function(g) { return g.id; }).join(",");
                    var server = window.location.hostname;

                    var iframeUrl = DASHBOARD_URL + 
                                    "?userName=" + encodeURIComponent(session.userName) + 
                                    "&sessionId=" + encodeURIComponent(session.sessionId) + 
                                    "&database=" + encodeURIComponent(session.database) + 
                                    "&server=" + encodeURIComponent(server) +
                                    "&groups=" + encodeURIComponent(groupIds); // Initial Load

                    var iframe = document.createElement('iframe');
                    iframe.src = iframeUrl;
                    iframe.style.width = "100%";
                    iframe.style.height = "100%";
                    iframe.style.border = "none";
                    
                    container.appendChild(iframe);
                    iframeRef = iframe; // Save reference
                    
                    if (overlay) overlay.style.display = 'none';
                    isRendered = true;

                    // --- LISTENER: WATCH FOR FILTER CHANGES ---
                    // This fires when user changes the group dropdown in MyGeotab
                    pageService.attach('filterChange', function(data) {
                        console.log("BRIDGE: Filter Changed!", data);
                        // data.groups contains the new array of groups
                        if (data && data.groups) {
                            sendGroupUpdate(data.groups);
                        }
                    });

                }).catch(function(err) {
                    console.error("BRIDGE: Init Failed", err);
                });
            };

            setTimeout(renderDashboard, 500);

            return {
                initialize: function (api, state, callback) { renderDashboard(); if (callback) callback(); },
                focus: function (api, state) { renderDashboard(); },
                blur: function () { }
            };
        };

        geotab.addin.fleetStatusOverview = fleetStatusAddin;
        geotab.addin.myMetrics = fleetStatusAddin;
    </script>
</body>
</html>
