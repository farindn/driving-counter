<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Geotab Bridge</title>
</head>
<body>
    
    <div id="geotab-map-addin-container" style="height:100vh; width:100%; overflow:hidden;">
        <h3>Loading Map Dashboard...</h3>
        <p id="debug-status">Initializing...</p>
    </div>

    <script type="text/javascript">
        // 1. Log to the browser console to confirm the file loaded
        console.log("BRIDGE: File has been loaded by Geotab.");

        // 2. The function name MUST match the config "name" (MyMetrics -> myMetrics)
        // Geotab automatically lowercases the first letter of the name in the config.
        geotab.addin.myMetrics = function (api, state) {
            
            console.log("BRIDGE: Geotab has found the function!");
            document.getElementById("debug-status").innerText = "Bridge function found...";

            // UPDATE THIS: Point to your Dashboard file
            var TARGET_APP_PAGE = "https://farindn.github.io/vehicle-status-addin/dashboard.html"; 
            var container = document.getElementById("geotab-map-addin-container");

            return {
                initialize: function (api, state, callback) {
                    console.log("BRIDGE: Initialize called.");
                    document.getElementById("debug-status").innerText = "Getting Session...";

                    api.getSession(function(session) {
                        console.log("BRIDGE: Session received.", session);
                        
                        var userName = session.userName;
                        var sessionId = session.sessionId;
                        var database = session.database;
                        var server = api.mobileCaller ? api.mobileCaller.server : window.location.hostname;

                        var iframeUrl = TARGET_APP_PAGE + 
                                        "?userName=" + encodeURIComponent(userName) + 
                                        "&sessionId=" + encodeURIComponent(sessionId) + 
                                        "&database=" + encodeURIComponent(database) + 
                                        "&server=" + encodeURIComponent(server);

                        var iframe = document.createElement('iframe');
                        iframe.src = iframeUrl;
                        iframe.style.width = "100%";
                        iframe.style.height = "100%";
                        iframe.style.border = "none";
                        
                        container.innerHTML = ""; 
                        container.appendChild(iframe);
                        console.log("BRIDGE: IFrame injected.");
                        
                        callback();
                    });
                },

                focus: function () { 
                    console.log("BRIDGE: Focus called.");
                },
                blur: function () { 
                    console.log("BRIDGE: Blur called.");
                }
            };
        };
    </script>
</body>
</html>
